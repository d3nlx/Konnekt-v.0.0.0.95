<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Chats</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      height: 100vh;
      display: flex;
    }

    .app {
      display: flex;
      width: 100%;
      height: 100%;
    }

    .header{
      background-color: rgb(241, 241, 241);
      position: fixed;
      top: 0px;
      left: 0px;
      right: 0px;
      height: 20px;
      z-index: 3;

      display: flex;
      flex-direction: row;
      justify-content: space-between;

      align-items: center;
    }

    .right-section{
      width: 150px;
    }

    .middle-section{
      width: 150px;
    }

    .title{
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      font-weight: bold;
      text-align: center;
      color: #007bff;
    }

    .left-section{
      width: 150px;
    }

    .creator{
      font-size: 11px;
      font-family: Arial, Helvetica, sans-serif;
      font-weight: bold;
      margin: 0;
      color: #007bff;
    }

    .sidebar-left{
      background-color: rgb(41, 58, 76);
      position: fixed;
      left: 0;
      bottom: 0;
      top: 0px;
      width: 70px;
      z-index: 2;

      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 35px;
    }

    .js-open-profile-button{
      background-color: transparent;
      border-style: none;
      cursor: pointer;
    }

    .js-open-profile-button-img{
      width: 25px;
      height: 25px;
    }

    /* Левая колонка (контакты) */
    .sidebar-middle{
      background-color: rgb(249, 248, 248);
      position: fixed;
      left: 70px;
      bottom: 0;
      top: 0px;
      width: 430px;
      z-index: 1;

      display: flex;
      flex-direction: column;
      
      padding-top: 20px;
    }

    .sidebar-middle-top-containder{
      display: flex;
      flex-direction: row;
      justify-content: center;
      margin-bottom: 10px;
    }

    .sidebar-middle-top-containder input {
      flex: 1;
      margin-top: 2px;
      margin-left: 5px;
      padding: 10px;
      padding-left: 15px;
      border-radius: 50px;
      border: none;
    }

    .sidebar-middle-top-containder button {
      border-radius: 50px;
      padding-left: 14px;
      padding-right: 14px;
      margin-top: 2px;
      margin-right: 5px;
      margin-left: 5px;
      background-color: #007bff;
      color: white;
      font-weight: bold;
      border: none;
    }

    .contact {
      padding: 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .contact:hover {
      background: #eaeaea;
    }

    .contact.active-contact {
      background-color: #007bff;
      color: white;
    }
    .contact.active-contact:hover {
      background-color: #006ae6;
    }

    /* Правая колонка (чат) */
    .sidebar-right {
      background-color: rgb(161, 224, 153);
      position: fixed;
      left: 500px;
      bottom: 0;
      top: 0;
      width: calc(100% - 500px);
      z-index: 1;

      display: flex;
      flex-direction: column; /* вертикальное расположение */
    }

    /* Заголовок */
    .chat-header {
      padding-top: 25px;
      padding-bottom: 10px;
      padding-left: 10px;
      background: rgb(249, 248, 248);
      border-bottom: 1px solid #ccc;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Сообщения занимают всё пространство между header и input */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px; /* расстояние между сообщениями */
    }

    /* Инпут внизу */
    .chat-input {
      display: flex;
      border-top: 1px solid #ccc;
      padding: 5px;
      background: #fff;
    }
    .chat-input input {
      flex: 1;
      padding: 10px;
      border: none;
      outline: none;
      margin-right: 10px;
    }
    .chat-input button {
      padding: 10px 20px;
      border: none;
      background: #007bff;
      color: #fff;
      cursor: pointer;
    }
    .chat-input button:hover {
      background: #0056b3;
    }

    .message {
      padding: 10px;
      border-radius: 10px;
      max-width: 60%;
      position: relative;
    }
    .outgoing {
      background: #d1f1ff;
      align-self: flex-end;
      text-align: right;
    }
    .incoming {
      background: #eee;
      align-self: flex-start;
    }

    .message-checkbox {
      position: absolute;
      top: 5px;
      left: 5px;
    }

    #delete-icon {
      background: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
      margin-left: auto;
    }
    .selected {
      background-color: rgba(255, 0, 0, 0.1) !important;
    }
  </style>
</head>
<body>

  <div class="header">
    <div class="right-section"></div>
    <div class="middle-section">
      <p class="title">Konnekt</p>
    </div>
    <div class="left-section">
      <p class="creator">DEV and SEO Denis Shvets</p>
    </div>
  </div>

   <div class="sidebar-left">
    <button class="js-open-profile-button">
      <img class="js-open-profile-button-img" src="imgs/icons8-menu-50.png">
    </button>
  </div>

  <div class="app">
    <!-- Список контактов -->
    <div class="sidebar-middle">
      <div class="sidebar-middle-top-containder">
        <input type="text" id="phonenumber" placeholder="Search..." />
        <button id="addContactBtn">+</button>
      </div>
      <div id="contactsList"></div>
    </div>

    <!-- Окно чата -->
    <div class="sidebar-right">
      <div class="sidebar-right-top-containder">
        <div class="chat-header" id="chatHeader">Choose your contact</div>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input">
        <input type="text" id="messageInput" placeholder="Type your message...">
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script type="module">
    const contactsList = document.getElementById('contactsList');
    const addBtn = document.getElementById('addContactBtn');
    const inputPhone = document.getElementById('phonenumber');

    const chatHeader = document.getElementById('chatHeader');
    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');

    let currentUserId = null;
    let currentChatId = null;
    let socket = null;
    let deleteMode = false;
    let selectedMessages = new Set();

    // =========================
    // 1. ПОЛЬЗОВАТЕЛЬ + СОКЕТ
    // =========================
    async function initUser() {
      const res = await fetch('/api/profile');
      const user = await res.json();
      currentUserId = user._id;

      socket = io();
      socket.on('new_message', ({ from, message, id, timestamp }) => {
        if (from === currentUserId) return;
        if (from !== currentChatId) return; // только активный чат
        appendMessage(false, message, id, timestamp);
      });

      socket.on('messages_deleted', ({ ids }) => {
        ids.forEach(id => {
          const msg = document.querySelector(`[data-id="${id}"]`);
          if (msg) msg.remove();
        });
        selectedMessages.clear();
        exitDeleteMode();
      });
    }

    // =========================
    // 2. КОНТАКТЫ
    // =========================
    async function loadContacts() {
      const res = await fetch('/api/contacts', { credentials: 'include' });
      const contacts = await res.json();

      contactsList.innerHTML = '';
      contacts.forEach(c => {
        const div = document.createElement('div');
        div.className = 'contact';
        div.dataset.id = c.id;
        div.innerHTML = `
          <span>${c.displayName} (${c.phonenumber})</span>
          <button class="delBtn">✕</button>
        `;

        // открыть чат по клику на карточку
        div.onclick = () => openChat(c);

        // удалить контакт (останавливаем всплытие, чтобы не открылся чат)
        div.querySelector('.delBtn').onclick = async (e) => {
          e.stopPropagation(); // <<< вот это важно
          const confirmed = confirm(`Удалить ${c.displayName}?`);
          if (!confirmed) return;
          await fetch(`/api/contacts/${c.contactEntryId}`, {
            method: 'DELETE',
            credentials: 'include'
          });
          await loadContacts();
        };

        contactsList.appendChild(div);
      });
    }

    addBtn.onclick = async () => {
      const number = inputPhone.value.trim();
      if (!number) return;
      await fetch('/api/contacts', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query: number })
      });
      inputPhone.value = '';
      await loadContacts();
    };

    // =========================
    // 3. ЧАТ
    // =========================
    async function openChat(contact) {
      currentChatId = contact.id;
      chatHeader.textContent = `Chat with ${contact.displayName}`;

      // Снятие выделения у всех
      document.querySelectorAll('.contact').forEach(el => {
        el.classList.remove('active-contact');
      });

      // Выделение текущего
      const activeEl = document.querySelector(`.contact[data-id="${contact.id}"]`);
      if (activeEl) activeEl.classList.add('active-contact');

      await loadMessages(contact.id);
    }

    async function loadMessages(contactId) {
      const res = await fetch(`/api/messages/${contactId}`);
      const messages = await res.json();
      chatMessages.innerHTML = '';
      messages.forEach(m => {
        appendMessage(m.sender === currentUserId, m.message, m.id, m.timestamp);
      });
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function appendMessage(isOwn, text, id = null, timestamp = null) {
      const div = document.createElement('div');
      div.className = `message ${isOwn ? 'outgoing' : 'incoming'}`;
      if (id) div.dataset.id = id;

      // текст
      const textSpan = document.createElement('span');
      textSpan.textContent = text;
      div.appendChild(textSpan);

      // время
      if (timestamp) {
        const time = document.createElement('div');
        const date = new Date(timestamp);
        time.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        time.style.fontSize = '0.75em';
        time.style.color = 'gray';
        time.style.marginTop = '4px';
        div.appendChild(time);
      }

      // если включен режим удаления
      if (deleteMode) {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'message-checkbox';
        checkbox.style.marginRight = '6px';
        div.prepend(checkbox);

        checkbox.addEventListener('change', () => {
          if (!id) return;
          if (checkbox.checked) {
            selectedMessages.add(id);
            div.classList.add('selected');
          } else {
            selectedMessages.delete(id);
            div.classList.remove('selected');
          }
        });
      }

      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    chatMessages.addEventListener('click', (e) => {
      if (e.target.classList.contains('message-checkbox')) return;

      const messageDiv = e.target.closest('.message');
      if (!messageDiv) return;

      if (deleteMode) {
        exitDeleteMode();
        return;
      }

      deleteMode = true;

      document.querySelectorAll('#chatMessages > .message').forEach((msgDiv) => {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'message-checkbox';
        checkbox.style.marginRight = '6px';
        msgDiv.prepend(checkbox);

        checkbox.addEventListener('change', () => {
          const id = msgDiv.dataset.id;
          if (!id) return;

          if (checkbox.checked) {
            selectedMessages.add(id);
            msgDiv.classList.add('selected');
          } else {
            selectedMessages.delete(id);
            msgDiv.classList.remove('selected');
          }
        });
      });

      showDeleteIcon();
    });

    function showDeleteIcon() {
      // если уже есть иконка — не добавляем вторую
      if (document.getElementById('delete-icon')) return;

      const deleteIcon = document.createElement('button');
      deleteIcon.id = 'delete-icon';
      deleteIcon.innerHTML = '🗑️';
      deleteIcon.title = 'Удалить сообщения';

      deleteIcon.addEventListener('click', async () => {
        for (const id of selectedMessages) {
          try {
            await fetch(`/api/messages/${id}`, { method: 'DELETE' });
          } catch (err) {
            console.error(`Ошибка при удалении ${id}:`, err);
          }
        }

        socket.emit('delete_message', {
          to: currentChatId,
          ids: Array.from(selectedMessages),
        });

        exitDeleteMode();
      });

      document.getElementById('chatHeader').appendChild(deleteIcon);
    }

    function exitDeleteMode() {
      deleteMode = false;
      selectedMessages.clear();
      document.querySelectorAll('.message-checkbox').forEach(cb => cb.remove());
      document.querySelectorAll('#chatMessages > .message').forEach(msgDiv => msgDiv.classList.remove('selected'));
      const icon = document.getElementById('delete-icon');
      if (icon) icon.remove();
    }

    sendBtn.onclick = async () => {
      if (!currentChatId || !messageInput.value.trim()) return;
      const text = messageInput.value.trim();

      const res = await fetch('/api/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ receiverId: currentChatId, message: text }),
      });

      const data = await res.json();
      appendMessage(true, text, data.data?.id, data.data?.timestamp);

      socket.emit('send_message', {
        to: currentChatId,
        message: text,
        id: data.data?.id,
        timestamp: data.data?.timestamp
      });

      messageInput.value = '';
    };

    document.querySelector('.js-open-profile-button').addEventListener('click', () => {
      window.location.href = 'profile.html'
    })

    // =========================
    // INIT
    // =========================
    await initUser();
    await loadContacts();
  </script>
</body>
</html>