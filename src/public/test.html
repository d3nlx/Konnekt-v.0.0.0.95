<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Chats</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      height: 100vh;
      display: flex;
    }

    .app {
      display: flex;
      width: 100%;
      height: 100%;
    }

    /* –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (–∫–æ–Ω—Ç–∞–∫—Ç—ã) */
    .contacts {
      width: 30%;
      max-width: 300px;
      border-right: 1px solid #ccc;
      overflow-y: auto;
      background: #f8f8f8;
      display: flex;
      flex-direction: column;
    }

    .contacts-header {
      padding: 10px;
      border-bottom: 1px solid #ccc;
      background: #eee;
      display: flex;
      gap: 5px;
    }

    .contacts-header input {
      flex: 1;
      padding: 5px;
    }

    .contact {
      padding: 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .contact:hover {
      background: #eaeaea;
    }

    /* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (—á–∞—Ç) */
    .chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .chat-header {
      padding: 15px;
      background: #f0f0f0;
      border-bottom: 1px solid #ccc;
      font-weight: bold;
    }

    .chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background: #fff;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .message {
      padding: 10px;
      border-radius: 10px;
      max-width: 60%;
      position: relative;
    }
    .outgoing {
      background: #d1f1ff;
      align-self: flex-end;
      text-align: right;
    }
    .incoming {
      background: #eee;
      align-self: flex-start;
    }

    .message-checkbox {
      position: absolute;
      top: 5px;
      left: 5px;
    }

    .chat-input {
      display: flex;
      border-top: 1px solid #ccc;
    }
    .chat-input input {
      flex: 1;
      padding: 10px;
      border: none;
      outline: none;
    }
    .chat-input button {
      padding: 10px 15px;
      border: none;
      background: #007bff;
      color: #fff;
      cursor: pointer;
    }
    .chat-input button:hover {
      background: #0056b3;
    }

    #delete-icon {
      position: absolute;
      top: 10px;
      right: 10px;
      background: transparent;
      border: none;
      font-size: 22px;
      cursor: pointer;
    }
    .selected {
      background-color: rgba(255, 0, 0, 0.1) !important;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ -->
    <div class="contacts">
      <div class="contacts-header">
        <input type="text" id="phonenumber" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä" />
        <button id="addContactBtn">+</button>
      </div>
      <div id="contactsList"></div>
    </div>

    <!-- –û–∫–Ω–æ —á–∞—Ç–∞ -->
    <div class="chat">
      <div class="chat-header" id="chatHeader">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç</div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input">
        <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
        <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script type="module">
    const contactsList = document.getElementById('contactsList');
    const addBtn = document.getElementById('addContactBtn');
    const inputPhone = document.getElementById('phonenumber');

    const chatHeader = document.getElementById('chatHeader');
    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');

    let currentUserId = null;
    let currentChatId = null;
    let socket = null;
    let deleteMode = false;
    let selectedMessages = new Set();

    // =========================
    // 1. –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ + –°–û–ö–ï–¢
    // =========================
    async function initUser() {
      const res = await fetch('/api/profile');
      const user = await res.json();
      currentUserId = user._id;

      socket = io();
      socket.on('new_message', ({ from, message, id, timestamp }) => {
        if (from === currentUserId) return;
        if (from !== currentChatId) return; // —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç
        appendMessage(false, message, id, timestamp);
      });

      socket.on('messages_deleted', ({ ids }) => {
        ids.forEach(id => {
          const msg = document.querySelector(`[data-id="${id}"]`);
          if (msg) msg.remove();
        });
        selectedMessages.clear();
        exitDeleteMode();
      });
    }

    // =========================
    // 2. –ö–û–ù–¢–ê–ö–¢–´
    // =========================
    async function loadContacts() {
      const res = await fetch('/api/contacts', { credentials: 'include' });
      const contacts = await res.json();

      contactsList.innerHTML = '';
      contacts.forEach(c => {
        const div = document.createElement('div');
        div.className = 'contact';
        div.dataset.id = c.id;
        div.innerHTML = `
          <span>${c.displayName} (${c.phonenumber})</span>
          <button class="delBtn">‚úï</button>
        `;

        // –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç
        div.querySelector('span').onclick = () => openChat(c);

        // —É–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç
        div.querySelector('.delBtn').onclick = async (e) => {
          e.stopPropagation();
          const confirmed = confirm(`–£–¥–∞–ª–∏—Ç—å ${c.displayName}?`);
          if (!confirmed) return;
          await fetch(`/api/contacts/${c.contactEntryId}`, {
            method: 'DELETE',
            credentials: 'include'
          });
          await loadContacts();
        };

        contactsList.appendChild(div);
      });
    }

    addBtn.onclick = async () => {
      const number = inputPhone.value.trim();
      if (!number) return;
      await fetch('/api/contacts', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query: number })
      });
      inputPhone.value = '';
      await loadContacts();
    };

    // =========================
    // 3. –ß–ê–¢
    // =========================
    async function openChat(contact) {
      currentChatId = contact.id;
      chatHeader.textContent = `–ß–∞—Ç —Å ${contact.displayName}`;
      await loadMessages(contact.id);
    }

    async function loadMessages(contactId) {
      const res = await fetch(`/api/messages/${contactId}`);
      const messages = await res.json();
      chatMessages.innerHTML = '';
      messages.forEach(m => {
        appendMessage(m.sender === currentUserId, m.message, m.id, m.timestamp);
      });
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function appendMessage(isOwn, text, id = null, timestamp = null) {
      const div = document.createElement('div');
      div.className = `message ${isOwn ? 'outgoing' : 'incoming'}`;
      if (id) div.dataset.id = id;

      // —Ç–µ–∫—Å—Ç
      const textSpan = document.createElement('span');
      textSpan.textContent = text;
      div.appendChild(textSpan);

      // –≤—Ä–µ–º—è
      if (timestamp) {
        const time = document.createElement('div');
        const date = new Date(timestamp);
        time.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        time.style.fontSize = '0.75em';
        time.style.color = 'gray';
        time.style.marginTop = '4px';
        div.appendChild(time);
      }

      // –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º —É–¥–∞–ª–µ–Ω–∏—è
      if (deleteMode) {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'message-checkbox';
        checkbox.style.marginRight = '6px';
        div.prepend(checkbox);

        checkbox.addEventListener('change', () => {
          if (!id) return;
          if (checkbox.checked) {
            selectedMessages.add(id);
            div.classList.add('selected');
          } else {
            selectedMessages.delete(id);
            div.classList.remove('selected');
          }
        });
      }

      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    chatMessages.addEventListener('click', (e) => {
      if (e.target.classList.contains('message-checkbox')) return;

      const messageDiv = e.target.closest('.message');
      if (!messageDiv) return;

      if (deleteMode) {
        exitDeleteMode();
        return;
      }

      deleteMode = true;

      document.querySelectorAll('#chatMessages > .message').forEach((msgDiv) => {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'message-checkbox';
        checkbox.style.marginRight = '6px';
        msgDiv.prepend(checkbox);

        checkbox.addEventListener('change', () => {
          const id = msgDiv.dataset.id;
          if (!id) return;

          if (checkbox.checked) {
            selectedMessages.add(id);
            msgDiv.classList.add('selected');
          } else {
            selectedMessages.delete(id);
            msgDiv.classList.remove('selected');
          }
        });
      });

      showDeleteIcon();
    });

    function showDeleteIcon() {
      const deleteIcon = document.createElement('button');
      deleteIcon.id = 'delete-icon';
      deleteIcon.innerHTML = 'üóëÔ∏è';
      deleteIcon.title = '–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è';

      deleteIcon.style.position = 'absolute';
      deleteIcon.style.top = '10px';
      deleteIcon.style.right = '10px';
      deleteIcon.style.background = 'transparent';
      deleteIcon.style.border = 'none';
      deleteIcon.style.fontSize = '24px';
      deleteIcon.style.cursor = 'pointer';
      deleteIcon.style.zIndex = '1000';

      deleteIcon.addEventListener('click', async () => {
        for (const id of selectedMessages) {
          try {
            await fetch(`/api/messages/${id}`, { method: 'DELETE' });
          } catch (err) {
            console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ ${id}:`, err);
          }
        }

        socket.emit('delete_message', {
          to: currentChatId,
          ids: Array.from(selectedMessages),
        });

        exitDeleteMode();
      });

      document.querySelector('.chat').appendChild(deleteIcon);
    }

    function exitDeleteMode() {
      deleteMode = false;
      selectedMessages.clear();
      document.querySelectorAll('.message-checkbox').forEach(cb => cb.remove());
      document.querySelectorAll('#chatMessages > .message').forEach(msgDiv => msgDiv.classList.remove('selected'));
      const icon = document.getElementById('delete-icon');
      if (icon) icon.remove();
    }

    sendBtn.onclick = async () => {
      if (!currentChatId || !messageInput.value.trim()) return;
      const text = messageInput.value.trim();

      const res = await fetch('/api/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ receiverId: currentChatId, message: text }),
      });

      const data = await res.json();
      appendMessage(true, text, data.data?.id, data.data?.timestamp);

      socket.emit('send_message', {
        to: currentChatId,
        message: text,
        id: data.data?.id,
        timestamp: data.data?.timestamp
      });

      messageInput.value = '';
    };

    // =========================
    // INIT
    // =========================
    await initUser();
    await loadContacts();
  </script>
</body>
</html>